<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PizzUM & BurgUM — Admin / Pedidos</title>

  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="stylesheet" th:href="@{/css/layout.css}">
  <link rel="stylesheet" th:href="@{/css/components.css}">
  <link rel="stylesheet" th:href="@{/css/pages.css}">
</head>
<body>
  <!-- Header admin -->
  <header class="site-header">
    <div class="container header__inner">
      <a class="brand" th:href="@{/static}">
        <img th:src="@{/img/logo.png}" alt="PizzUM &amp; BurgUM" class="brand__logo">
        <span class="brand__name">PizzUM &amp; BurgUM</span>
      </a>
      <nav class="site-nav">
        <a class="nav__link" th:href="@{/templates/admin}">Panel</a>
        <a class="nav__link" th:href="@{/admin/productos}">Productos</a>
        <a class="nav__link is-active" th:href="@{/admin/pedidos}">Pedidos</a>
        <a class="nav__link" th:href="@{/admin/historial}">Historial</a>
        <a class="nav__link" th:href="@{/admin/administradores}">Administradores</a>
        <a class="nav__link" th:href="@{/login}">Cerrar sesión</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="container section">
      <h1>Pedidos en curso</h1>
      <p class="form-hint">Buscá por número de pedido para gestionarlo rápidamente.</p>
    </section>

    <!-- Filtro solo por número -->
    <section class="container section">
      <form class="form-section form-section--row" method="get" th:action="@{/admin/pedidos}">
        <div class="form-group">
          <label for="f_numero">Nº de pedido</label>
          <input class="input" id="f_numero" name="numero" type="text" placeholder="Ej: 000123">
        </div>
        <div class="form-actions">
          <button class="btn btn--primary" type="submit">Buscar</button>
          <a class="btn btn--ghost" th:href="@{/admin/pedidos}">Limpiar</a>
        </div>
      </form>
    </section>

    <!-- Lista de pedidos -->
      <section class="container section">
          <div class="card">
              <h2 style="margin-bottom: .5rem;">Resultados</h2>
              <p class="form-hint" style="margin-top: 0;" th:if="${pedidos != null and !pedidos.isEmpty()}">
                  Mostrando <span th:text="${pedidos.size()}"></span> pedido(s) activo(s).
              </p>
              <p class="form-hint" style="margin-top: 0;" th:if="${pedidos == null or pedidos.isEmpty()}">
                  No se encontraron pedidos activos.
              </p>

              <!-- Mensajes de éxito/error -->
              <div th:if="${msg}" class="alert alert-success" style="margin-top: var(--space-4);">
                  <span th:text="${msg}"></span>
              </div>
              <div th:if="${error}" class="alert alert-error" style="margin-top: var(--space-4);">
                  <span th:text="${error}"></span>
              </div>

              <!-- Pedidos dinámicos -->
              <article th:each="pedido : ${pedidos}"
                       class="order-item"
                       style="display:grid;grid-template-columns:1fr auto;gap:var(--space-4);padding:var(--space-4);border:1px solid var(--color-border);border-radius:var(--radius-md);margin-top:var(--space-4);">

                  <div style="display:grid;gap:.35rem;">
                      <h3 style="margin:0;">Pedido #<span th:text="${#strings.format('%06d', pedido.id)}">000000</span></h3>
                      <small>
                          Creado: <span th:text="${#temporals.format(pedido.date, 'dd/MM/yyyy HH:mm')}">fecha</span> —
                          Cliente: <span th:text="${pedido.client.nombre + ' ' + pedido.client.apellido}">Cliente</span> —
                          Tel: <span th:text="${pedido.client.telefono}">teléfono</span>
                      </small>
                      <small>Domicilio: <span th:text="${pedido.address}">dirección</span></small>

                      <div class="summary-list">
                          <div><strong>Items:</strong>
                              <span th:each="pizza : ${pedido.pizzas}">
              Pizza <span th:text="${pizza.tamaño}">tamaño</span> (<span th:text="${pizza.nombre}">nombre</span>) x1 ·
            </span>
                              <span th:each="hamburguesa : ${pedido.hamburguesas}">
              Burger <span th:text="${hamburguesa.nombre}">nombre</span> x1 ·
            </span>
                              <span th:each="acompanamiento : ${pedido.acompanamientos}">
              <span th:text="${acompanamiento.name}">acompañamiento</span> x1 ·
            </span>
                              <span th:each="bebida : ${pedido.bebidas}">
              <span th:text="${bebida.name}">bebida</span> x1
            </span>
                          </div>
                      </div>

                      <div><strong>Total:</strong> $<span th:text="${#numbers.formatDecimal(pedido.totalCost, 1, 2)}">0.00</span></div>
                      <div><strong>Estado actual:</strong>
                          <span class="badge"
                                th:classappend="${pedido.status?.name() == 'EN_COLA'} ? '' :
                               ${pedido.status?.name() == 'EN_PREPARACION'} ? 'badge--accent' :
                               ${pedido.status?.name() == 'EN_CAMINO'} ? 'badge--primary' : 'badge--success'"
                                th:text="${pedido.status?.name()?.replace('_', ' ')}">Estado</span>
                      </div>
                  </div>

                  <!-- Acciones de cambio de estado -->
                  <div>
                      <form method="post" th:action="@{/admin/pedidos}" class="card" style="padding:var(--space-4);min-width:260px;">
                          <h4 style="margin-bottom:var(--space-3);">Cambiar estado</h4>
                          <div class="form-group">
                              <label class="option">
                                  <input type="radio" name="estado" value="en_cola" th:checked="${pedido.status?.name() == 'EN_COLA'}">
                                  <span class="option__label">En cola</span>
                              </label>
                              <label class="option">
                                  <input type="radio" name="estado" value="en_preparacion" th:checked="${pedido.status?.name() == 'EN_PREPARACION'}">
                                  <span class="option__label">En preparación</span>
                              </label>
                              <label class="option">
                                  <input type="radio" name="estado" value="en_camino" th:checked="${pedido.status?.name() == 'EN_CAMINO'}">
                                  <span class="option__label">En camino</span>
                              </label>
                              <label class="option">
                                  <input type="radio" name="estado" value="entregado" th:checked="${pedido.status?.name() == 'ENTREGADO'}">
                                  <span class="option__label">Entregado</span>
                              </label>
                          </div>
                          <div class="form-actions">
                              <button class="btn btn--primary" type="submit">Actualizar</button>
                          </div>
                          <input type="hidden" name="pedido_id" th:value="${pedido.id}">
                      </form>
                  </div>
              </article>

          </div>
      </section>
    </main>
</body>
</html>
