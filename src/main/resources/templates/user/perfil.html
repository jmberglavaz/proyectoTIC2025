<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mi Perfil - PizzUM & BurgUM</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/pages.css}">
</head>
<body class="theme-italian">
<header class="site-header">
    <div class="container header__inner">
        <div class="header-left">
            <a class="brand" th:href="@{/}">
                <img th:src="@{/img/logo.png}" alt="PizzUM &amp; BurgUM" class="brand__logo">
                <span class="brand__name">PizzUM &amp; BurgUM</span>
            </a>
        </div>
        <nav class="site-nav">
            <a class="nav__link" th:href="@{/crear-pizza}">Crear pizza</a>
            <a class="nav__link" th:href="@{/crear-burger}">Crear hamburguesa</a>
            <a class="nav__link" th:href="@{/carrito}">Carrito</a>
            <a class="nav__link" th:href="@{/pedido}">Pedidos</a>
        </nav>
        <div class="header-right">
            <div class="user-info">
                <a th:href="@{/perfil}" class="user-link" style="text-decoration: none; color: inherit;">
                    <span>Hola, <strong th:text="${session.clienteNombre}"></strong></span>
                </a>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit" class="btn btn--link">Cerrar Sesi√≥n</button>
                </form>
            </div>
        </div>
    </div>
</header>

<main class="container">
    <div class="profile-container">
        <h1 class="page-title">Mi Perfil</h1>

        <!-- Mensajes Flash -->
        <div th:if="${success}" class="alert alert--success">
            <span class="alert__icon">‚úÖ</span>
            <span class="alert__message" th:text="${success}"></span>
        </div>

        <div th:if="${error}" class="alert alert--error">
            <span class="alert__icon">‚ùå</span>
            <span class="alert__message" th:text="${error}"></span>
        </div>

        <!-- Informaci√≥n Personal -->
        <section class="profile-section">
            <h2 class="section-title">Informaci√≥n Personal</h2>
            <div class="user-info-grid">
                <div class="info-item">
                    <label>Nombre:</label>
                    <span th:text="${cliente.firstName}"></span>
                </div>
                <div class="info-item">
                    <label>Apellido:</label>
                    <span th:text="${cliente.lastName}"></span>
                </div>
                <div class="info-item">
                    <label>Fecha de Nacimiento:</label>
                    <span th:text="${#temporals.format(cliente.birthDate, 'dd/MM/yyyy')}"></span>
                </div>
                <div class="info-item">
                    <label>Email:</label>
                    <span th:text="${cliente.email}"></span>
                </div>
                <div class="info-item">
                    <label>C√©dula:</label>
                    <span th:text="${cliente.id}"></span>
                </div>
                <div class="info-item">
                    <label>Tel√©fono:</label>
                    <span th:text="${cliente.phoneNumber}"></span>
                </div>
            </div>
        </section>

        <!-- Cambiar Contrase√±a -->
        <section class="profile-section">
            <h2 class="section-title">Cambiar Contrase√±a</h2>
            <form th:action="@{/perfil/cambiar-password}" method="post" class="password-form">
                <div class="form-group">
                    <label for="nuevaPassword">Nueva Contrase√±a:</label>
                    <input type="password" id="nuevaPassword" name="nuevaPassword"
                           class="form-input" required>
                </div>
                <button type="submit" class="btn btn--primary">Actualizar Contrase√±a</button>
            </form>
        </section>

        <!-- Direcciones -->
        <section class="profile-section">
            <h2 class="section-title">Mis Direcciones</h2>

            <!-- Agregar Nueva Direcci√≥n -->
            <div class="add-address-card">
                <h3>Agregar Nueva Direcci√≥n</h3>
                <form th:action="@{/perfil/direcciones}" method="post" th:object="${nuevaDireccion}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="alias">Alias (ej: Casa, Trabajo):</label>
                            <input type="text" id="alias" th:field="*{alias}"
                                   class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Direcci√≥n Completa:</label>
                            <input type="text" id="address" th:field="*{address}"
                                   class="form-input" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="indications">Indicaciones Adicionales:</label>
                            <textarea id="indications" th:field="*{indications}"
                                      class="form-input" rows="4"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn--primary">‚ûï Agregar Direcci√≥n</button>
                </form>
            </div>

            <!-- Lista de Direcciones Existentes -->
            <div class="addresses-list">
                <div th:each="direccion : ${direcciones}" class="address-card">
                    <div class="address-header">
                        <h3 class="address-alias" th:text="${direccion.alias}"></h3>
                        <div class="address-badges">
                            <span th:if="${direccion.isDefect}" class="badge badge--primary">üìç Predeterminada</span>
                        </div>
                    </div>
                    <p class="address-text" th:text="${direccion.address}"></p>
                    <p th:if="${direccion.indications}" class="address-indications"
                       th:text="${direccion.indications}"></p>

                    <div class="address-actions">
                        <form th:action="@{/perfil/direcciones/{id}/default(id=${direccion.id})}"
                              method="post" class="action-form">
                            <button type="submit" class="btn btn--outline"
                                    th:classappend="${direccion.isDefect} ? 'btn--primary' : 'btn--outline'"
                                    th:disabled="${direccion.isDefect}">
                                <span th:if="${!direccion.isDefect}">üéØ Establecer como Predeterminada</span>
                                <span th:if="${direccion.isDefect}">‚úÖ Ya es Predeterminada</span>
                            </button>
                        </form>

                        <form th:action="@{/perfil/direcciones/{id}/delete(id=${direccion.id})}"
                              method="post" class="action-form"
                              th:if="${!direccion.isDefect or direcciones.size() > 1}">
                            <button type="submit" class="btn btn--danger"
                                    onclick="return confirm('¬øEst√°s seguro de que quieres eliminar esta direcci√≥n?')">
                                üóëÔ∏è Eliminar Direcci√≥n
                            </button>
                        </form>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(direcciones)}" class="empty-state">
                    <p>üì≠ No tienes direcciones registradas</p>
                    <p class="empty-state__text">Agrega tu primera direcci√≥n para recibir tus pedidos</p>
                </div>
            </div>
        </section>

        <!-- Medios de Pago -->
        <section class="profile-section">
            <h2 class="section-title">Mis Medios de Pago</h2>

            <!-- Medios de Pago - Versi√≥n Simplificada -->
            <section class="profile-section">
                <h2 class="section-title">Mis Medios de Pago</h2>

                <!-- Agregar Nueva Tarjeta (mantenemos igual) -->
                <div class="add-card-card">
                    <h3>Agregar Nueva Tarjeta</h3>
                    <form th:action="@{/perfil/medios-pago}" method="post">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="cardNumber">N√∫mero de Tarjeta:</label>
                                <input type="text" id="cardNumber" name="cardNumber" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="cvv">CVV:</label>
                                <input type="text" id="cvv" name="cvv" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="firstNameOnCard">Nombre en la Tarjeta:</label>
                                <input type="text" id="firstNameOnCard" name="firstNameOnCard" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="lastNameOnCard">Apellido en la Tarjeta:</label>
                                <input type="text" id="lastNameOnCard" name="lastNameOnCard" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="expirationMonth">Mes de Vencimiento:</label>
                                <input type="text" id="expirationMonth" name="expirationMonth" class="form-input" required placeholder="MM" inputmode="numeric" pattern="[0-9]{1,2}">
                            </div>
                            <div class="form-group">
                                <label for="expirationYear">A√±o de Vencimiento:</label>
                                <input type="text" id="expirationYear" name="expirationYear" class="form-input" required placeholder="AA o AAAA" inputmode="numeric" pattern="[0-9]{2,4}">
                            </div>
                        </div>
                        <button type="submit" class="btn btn--primary">üí≥ Agregar Tarjeta</button>
                    </form>
                </div>

                <!-- Lista Simplificada de Tarjetas -->
                <div class="simple-cards-list">
                    <h3>Tus Tarjetas:</h3>

                    <div th:each="tarjeta : ${mediosDePago}" class="simple-card-item"
                         style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9;">

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>
                                    <span th:if="${tarjeta.cardNumber.toString().startsWith('4')}">üí≥ Visa</span>
                                    <span th:if="${tarjeta.cardNumber.toString().startsWith('5')}">üí≥ Mastercard</span>
                                    <span th:if="${!tarjeta.cardNumber.toString().startsWith('4') and !tarjeta.cardNumber.toString().startsWith('5')}">üí≥ Otra</span>
                                </strong>
                                - ****<span th:text="${#strings.substring(tarjeta.cardNumber.toString(), #strings.length(tarjeta.cardNumber.toString()) - 4)}"></span>
                                <br>
                                <small>
                                    <span th:text="${tarjeta.firstNameOnCard}"></span>
                                    <span th:text="${tarjeta.lastNameOnCard}"></span>
                                    ‚Ä¢ Vence: <span th:text="${#temporals.format(tarjeta.expirationDate, 'MM/yyyy')}"></span>
                                </small>
                            </div>

                            <form th:action="@{/perfil/medios-pago/{cardNumber}/delete(cardNumber=${tarjeta.cardNumber})}"
                                  method="post" style="margin: 0;">
                                <button type="submit" class="btn btn--danger"
                                        onclick="return confirm('¬øEst√°s seguro de que quieres eliminar esta tarjeta?')"
                                        style="padding: 5px 10px; font-size: 12px;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </form>
                        </div>
                    </div>

                    <div th:if="${#lists.isEmpty(mediosDePago)}" class="empty-state">
                        <p>üí≥ No tienes tarjetas registradas</p>
                        <p class="empty-state__text">Agrega una tarjeta para pagar tus pedidos m√°s r√°pido</p>
                    </div>
                </div>
            </section>
        </section>
    </div>
</main>

<footer class="site-footer">
    <div class="container footer__inner">
        <small>&copy; 2025 PizzUM &amp; BurgUM</small>
        <nav class="footer-nav">
            <a th:href="@{/ayuda}" class="footer__link">Ayuda</a>
            <a th:href="@{/terminos}" class="footer__link">T√©rminos</a>
            <a th:href="@{/privacidad}" class="footer__link">Privacidad</a>
        </nav>
    </div>
</footer>
</body>
</html>
